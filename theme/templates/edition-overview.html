{%- macro taxonomy(elements, path=None, prefix=None, nested=True) -%}
  {% if prefix %}
    {% for element in elements %}
      {% if prefix[0].strip() == element[1] %}
        {{ taxonomy(element[2], path + [element[1]] if path else [element[1]], prefix=prefix[1:], nested=False) }}
      {% endif %}
    {% endfor %}
  {% else %}
    <ul class="menu vertical {{ 'nested' if nested else ''}}">
      {% for element in elements %}
        <li{% if not nested %} id="section-{{ loop.index }}"{% endif %}>
          {% if pages|selectattr('taxonomy', 'equalto', ', '.join(path + [element[1]] if path else [element[1]]))|first() %}
            <a href="{{ SITEURL }}/pages/digitale-gesamtausgabe/{% if path %}{{ '/'.join(path) }}/{% endif %}{{ element[1] }}.html">{{ element[0] }}</a>
          {% else %}
            <span class="menu-text">{{ element[0] }}</span>
          {% endif %}
          {% if element[2] %}
            {{ taxonomy(element[2], path=path + [element[1]] if path else [element[1]]) }}
          {% endif %}
        </li>
      {% endfor %}
    </ul>
  {% endif %}
{%- endmacro -%}
{%- macro quick_nav(elements, prefix=None) -%}
  {% if prefix %}
    {% for element in elements %}
      {% if prefix[0].strip() == element[1] %}
        {{ quick_nav(element[2], prefix=prefix[1:]) }}
      {% endif %}
    {% endfor %}
  {% else %}
    {% for element in elements %}
      <li><a href="#section-{{ loop.index }}">{{ element[0] }}</a></li>
    {% endfor %}
  {% endif %}
{%- endmacro -%}
{% extends "page.html" %}
{% block breadcrumb_title %}{{ page.title }}{% endblock %}
{% block head_scripts %}
  <script src="{{ SITEURL }}/{{ THEME_STATIC_DIR }}/js/femtoTween.umd.js"></script>
{% endblock %}
{% block content %}
  {{ super() }}
  <ul class="tabs" data-tabs id="werke-tabs">
    <li class="tabs-title is-active"><a href="#einzelwerke" aria-selected="true">Einzelwerke</a></li>
    <li class="tabs-title"><a href="#chronologisch">Chronologisch</a></li>
    <li class="tabs-title"><a href="#alphabetisch">Alphabetisch</a></li>
  </ul>
  <div class="tabs-content" data-tabs-content="werke-tabs">
    <div class="tabs-panel is-active taxonomy-tree" id="einzelwerke">
      <div class="grid-x">
        <div class="small-12 medium-8">
          {{ taxonomy(TAXONOMY, prefix=page.taxonomy.split(',') if page.taxonomy else None, nested=False) }}
        </div>
        <div class="hide-for-small-only medium-4">
          <ul class="menu vertical sticky quick-nav">
            {{ quick_nav(TAXONOMY, prefix=page.taxonomy.split(',') if page.taxonomy else None) }}
          </ul>
        </div>
      </div>
    </div>
    <div class="tabs-panel" id="chronologisch">
      <ul class="menu vertical">
        {% for grouper, year_items in pages|selectattr('taxonomy')|selectattr('taxonomy', 'startswith', page.taxonomy)|selectattr('year')|groupby('year') %}
          <li><span class="menu-text">{{ grouper }}</span>
            <ul class="menu vertical nested">
              {% for grouper, items in year_items|groupby('month') %}
                <li>{% if grouper[1] %}<span class="menu-text">{{ grouper[1] }}</span>{% endif %}
                  <ul class="menu vertical nested">
                    {% for child in items|sort(attribute='date')|sort(attribute='title') %}
                      <li><a href="{{ SITEURL }}/{{ child.url }}">{{ child.title }}</a></li>
                    {% endfor %}
                  </ul>
                </li>
              {% endfor %}
            </ul>
          </li>
        {% endfor %}
      </ul>
    </div>
    <div class="tabs-panel" id="alphabetisch">
      <ul class="menu vertical">
        {% for grouper, items in pages|selectattr('taxonomy')|selectattr('taxonomy', 'startswith', page.taxonomy)|selectattr('title-letter')|groupby('title-letter') %}
          <li><span class="menu-text">{{ grouper }}</span>
            <ul class="menu vertical nested">
              {% for child in items|sort(attribute='title') %}
                <li><a href="{{ SITEURL }}/{{ child.url }}">{{ child.title }}</a></li>
              {% endfor %}
            </ul>
          </li>
        {% endfor %}
      </ul>
    </div>
  </div>
{% endblock %}
{% block body_scripts %}
<script>
if (Foundation.MediaQuery.is('medium')) {
    const topOffset = document.querySelector('#einzelwerke').offsetTop - 50;

    function quickNavClick(ev) {
        ev.preventDefault();
        const element = document.querySelector(ev.target.getAttribute('href'));
        femtoTween.tween(document.documentElement.scrollTop, topOffset + element.offsetTop, (value) => { document.documentElement.scrollTop = value; });
    }

    const quickNavLinks = document.querySelectorAll('.quick-nav a');
    const quickNavTargets = [];
    for(let idx = 0; idx < quickNavLinks.length; idx++) {
        quickNavLinks[idx].addEventListener('click', quickNavClick);
        quickNavTargets.push(document.querySelector(quickNavLinks[idx].getAttribute('href')));
    }

    console.log(window.innerHeight);
    window.addEventListener('scroll', function() {
        const scrollPos = document.documentElement.scrollTop - topOffset + (window.innerHeight / 2);
        current = false;
        for(let idx = quickNavTargets.length - 1; idx > 0; idx--) {
            if (current) {
              quickNavLinks[idx].parentElement.classList.remove('active');
            } else {
                if (quickNavTargets[idx].offsetTop < scrollPos) {
                    current = true;
                    quickNavLinks[idx].parentElement.classList.add('active');
                } else {
                    quickNavLinks[idx].parentElement.classList.remove('active');
                }
            }
        }
        if (!current) {
            quickNavLinks[0].parentElement.classList.add('active');
        } else {
            quickNavLinks[0].parentElement.classList.remove('active');
        }
    });
}
</script>
{% endblock body_scripts %}
