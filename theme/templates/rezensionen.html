{% extends "page.html" %}
{% block breadcrumb_title %}{{ page.title }}{% endblock %}
{% block head_scripts %}
  <script src="{{ SITEURL }}/{{ THEME_STATIC_DIR }}/js/femtoTween.umd.js"></script>
{% endblock %}
{% block content %}
  {{ super() }}
  <div class="grid-x">
    <div class="small-12 medium-8">
      <div id="chronologisch">
        <ul class="menu vertical">
          {% for grouper, articles in articles|selectattr('category.slug', '==', 'rezension')|sgroupby('date.year') %}
            <li id="year-{{ grouper }}">
              <span class="menu-text">{{ grouper }}</span>
              <ul class="menu vertical nested">
                {% for article in articles|sort(attribute='date', reverse=True) %}
                  <li id="{{ article.slug }}" class="margin-bottom-wide">
                    <h2 class="menu-text">{{ article.title }}</h2>
                    <div class="grid-x margin-bottom metadata">
                      <div class="cell small-12 medium-6">{{ article.publication }}</div>
                      <div class="cell small-12 medium-6 text-right">Von {{ article.author }}</div>
                    </div>
                    {{ article.content }}
                  </li>
                {% endfor %}
              </ul>
            </li>
          {% endfor %}
        </ul>
      </div>
    </div>
    <div class="hide-for-small-only medium-4 padding-left-wide">
      <ul class="menu vertical sticky quick-nav">
        {% for grouper, articles in articles|selectattr('category.slug', '==', 'rezension')|sgroupby('date.year') %}
          <li>
            <a href="#year-{{ grouper }}">{{ grouper }}</a>
            {% if loop.index0 < 3 %}
            <ul class="menu vertical nested">
              {% for article in articles|sort(attribute='date', reverse=True) %}
                <li><a href="#{{ article.slug }}">{{ article.publication }}</a></li>
              {% endfor %}
            </ul>
            {% endif %}
          </li>
        {% endfor %}
      </ul>
    </div>
  </div>
{% endblock %}
{% block body_scripts %}
<script>
if (Foundation.MediaQuery.is('medium')) {
    const topOffset = document.querySelector('#chronologisch').offsetTop - 50;

    function offsetTop(element) {
        if (element.localName === 'body') {
            return 0;
        } else {
            return offsetTop(element.offsetParent) + element.offsetTop;
        }
    }

    function quickNavClick(ev) {
        ev.preventDefault();
        const element = document.querySelector(ev.target.getAttribute('href'));
        let offsetTarget = offsetTop(element) - 90;
        if (!element.offsetParent.classList.contains('nested')) {
            offsetTarget = offsetTop(element) - 50;
        }
        femtoTween.tween(document.documentElement.scrollTop, offsetTarget, (value) => { document.documentElement.scrollTop = value; });
    }

    const quickNavLinks = document.querySelectorAll('.quick-nav a');
    const quickNavTargets = [];
    for(let idx = 0; idx < quickNavLinks.length; idx++) {
        quickNavLinks[idx].addEventListener('click', quickNavClick);
        quickNavTargets.push(offsetTop(document.querySelector(quickNavLinks[idx].getAttribute('href'))));
    }

    window.addEventListener('scroll', function() {
        const scrollPos = document.documentElement.scrollTop - topOffset + (window.innerHeight / 2);
        current = false;
        for(let idx = quickNavTargets.length - 1; idx > 0; idx--) {
            if (current) {
              quickNavLinks[idx].parentElement.classList.remove('active');
            } else {
                if (quickNavTargets[idx] < scrollPos) {
                    current = true;
                    quickNavLinks[idx].parentElement.classList.add('active');
                } else {
                    quickNavLinks[idx].parentElement.classList.remove('active');
                }
            }
        }
        if (!current) {
            quickNavLinks[0].parentElement.classList.add('active');
        } else {
            quickNavLinks[0].parentElement.classList.remove('active');
        }
    });
}
</script>
{% endblock body_scripts %}
